name: Release & Publish

on:
  release:
    types: [created]

env:
  CARGO_TERM_COLOR: always

jobs:
  version-bump:
    name: Sync versions + Commit bump + Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: get_version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"

      - name: Switch to main branch BEFORE editing files
        run: |
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="main"
          fi
          if ! git ls-remote --exit-code origin "$DEFAULT_BRANCH"; then
            echo "Default branch '$DEFAULT_BRANCH' not found, falling back to 'master'"
            DEFAULT_BRANCH="master"
          fi
          git fetch origin "$DEFAULT_BRANCH"
          git checkout "$DEFAULT_BRANCH"
          git pull origin "$DEFAULT_BRANCH"
          echo "✓ Now working on $DEFAULT_BRANCH branch"

      - name: Update version in package.json
        run: |
          jq --arg v "${{ steps.get_version.outputs.version }}" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          echo "✓ Updated package.json"

      - name: Update version in Cargo.toml
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ steps.get_version.outputs.version }}\"/" Cargo.toml
          echo "✓ Updated Cargo.toml"

      - name: Commit version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add package.json Cargo.toml
          git commit -m "chore: version bump to ${{ steps.get_version.outputs.version }}" || echo "No version changes to commit"
          git push || true
          echo "✓ Version bump step completed"

      - name: Generate Changelog
        run: |
          node scripts/generate-changelog.js
          echo "✓ Changelog generated"

      - name: Update GitHub Release Notes
        uses: softprops/action-gh-release@v2
        with:
          files: ""
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish to npm
    needs:
      - version-bump
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org/

      - name: Authenticate npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          echo "✓ npm authentication configured"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Pre-publish validation
        run: node scripts/prepublish.js

      - name: Publish package
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify published version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          npm view @doplan-dev/cli@$VERSION version
          echo "✓ Published @doplan-dev/cli@$VERSION"
